pipeline {
  agent {
    docker {
      image 'node:18-bullseye'
      args  '--network host'
    }
  }

  environment {
    SERVER_IP      = '172.31.7.249'
    SSH_CREDENTIAL = 'node-app-key'
    REPO_URL       = 'https://github.com/RajAhire-1/node-app-devops.git'
    BRANCH         = 'main'
    REMOTE_USER    = 'ubuntu'
    REMOTE_PATH    = '/home/ubuntu/node-app'
    NODE_ENV       = 'production'
    APP_NAME       = 'cinelite-app'
  }

  stages {
    stage('Checkout Code') {
      steps {
        echo 'üì¶ Cloning repository...'
        checkout([$class: 'GitSCM', branches: [[name: "*/${BRANCH}"]], userRemoteConfigs: [[url: "${REPO_URL}"]]])
      }
    }

    stage('Agent Diagnostics') {
      steps {
        sh 'echo "Node:"; node -v || true'
        sh 'echo "npm:"; npm -v || true'
        sh 'echo "pwd: $(pwd)"'
      }
    }

    stage('Install Dependencies') {
      steps {
        echo 'üì¶ Installing dependencies inside container...'
        sh 'npm ci || npm install'
      }
    }

    stage('Run Checks') {
      steps {
        echo 'üß™ No tests configured ‚Äî skipping (add your tests here).'
      }
    }

    stage('Deploy to EC2') {
      steps {
        sshagent([SSH_CREDENTIAL]) {
          sh """
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} 'mkdir -p ${REMOTE_PATH}'
            scp -o StrictHostKeyChecking=no -r * ${REMOTE_USER}@${SERVER_IP}:${REMOTE_PATH}/
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} '
              cd ${REMOTE_PATH} &&
              npm install --omit=dev &&
              pm2 start start.js --name ${APP_NAME} || pm2 restart ${APP_NAME}
            '
          """
        }
      }
    }
  }

  post {
    success { echo '‚úÖ Deployed successfully' }
    failure { echo '‚ùå Deployment failed ‚Äî check logs' }
    always  { echo 'üìú Pipeline finished' }
  }
}
