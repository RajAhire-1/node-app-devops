pipeline {
  agent any

  environment {
    SERVER_IP      = '172.31.7.249'
    SSH_CREDENTIAL = 'node-app-key'
    REPO_URL       = 'https://github.com/RajAhire-1/node-app-devops.git'
    BRANCH         = 'main'
    REMOTE_USER    = 'ubuntu'
    REMOTE_PATH    = '/home/ubuntu/node-app'
    NODE_IMAGE     = 'node:18-bullseye'
    APP_NAME       = 'cinelite-app'
  }

  stages {
    stage('Checkout Code') {
      steps {
        echo 'üì¶ Cloning repository...'
        checkout([$class: 'GitSCM', branches: [[name: "*/${BRANCH}"]], userRemoteConfigs: [[url: "${REPO_URL}"]]])
      }
    }

    stage('Agent Diagnostics') {
      steps {
        sh 'echo "=== Agent info ==="'
        sh 'whoami || true'
        sh 'id || true'
        sh 'git --version || true'
        sh 'docker --version || echo "docker CLI not found"'
      }
    }

    stage('Install Dependencies (in Docker)') {
      steps {
        echo "üì¶ Installing dependencies using Docker image ${NODE_IMAGE}"
        // run npm install inside a temporary container; mounts the workspace
        sh '''
          docker run --rm -v "$PWD":/workspace -w /workspace ${NODE_IMAGE} /bin/bash -lc "npm ci || npm install"
        '''
      }
    }

    stage('Run Lint / Build Checks') {
      steps {
        echo 'üß™ Running checks (customize as needed)'
        sh '''
          docker run --rm -v "$PWD":/workspace -w /workspace ${NODE_IMAGE} /bin/bash -lc "echo No tests defined"
        '''
      }
    }

    stage('Deploy to EC2') {
      steps {
        sshagent([env.SSH_CREDENTIAL]) {
          sh """
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} 'mkdir -p ${REMOTE_PATH}'
            scp -o StrictHostKeyChecking=no -r * ${REMOTE_USER}@${SERVER_IP}:${REMOTE_PATH}/
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} '
              cd ${REMOTE_PATH} &&
              npm install --omit=dev &&
              pm2 start start.js --name ${APP_NAME} || pm2 restart ${APP_NAME}
            '
          """
        }
      }
    }
  }

  post {
    success { echo '‚úÖ Deploy succeeded' }
    failure { echo '‚ùå Deploy failed ‚Äî check logs' }
    always  { echo 'üìú Pipeline finished' }
  }
}
