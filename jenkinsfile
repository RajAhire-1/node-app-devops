pipeline {
  agent any

  environment {
    SERVER_IP      = '172.31.7.249'
    SSH_CREDENTIAL = 'node-app-key'
    REPO_URL       = 'https://github.com/RajAhire-1/node-app-devops.git'
    BRANCH         = 'main'
    REMOTE_USER    = 'ubuntu'
    REMOTE_PATH    = '/home/ubuntu/node-app'
    APP_NAME       = 'cinelite-app'
  }

  stages {
    stage('Checkout Code') {
      steps {
        git branch: "${BRANCH}", url: "${REPO_URL}"
      }
    }

    stage('Install (local)') {
      steps {
        echo "Install deps on agent (optional) ..."
        sh 'echo "Skipping local install (build on remote). "'
      }
    }

    stage('Deploy to EC2 (tar over SSH)') {
      steps {
        sshagent([SSH_CREDENTIAL]) {
          sh """
            # prepare remote temp dir
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} 'rm -rf ${REMOTE_PATH}.tmp && mkdir -p ${REMOTE_PATH}.tmp'
            # stream compressed archive into remote temp dir
            tar -czf - . | ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} 'tar -xzf - -C ${REMOTE_PATH}.tmp'
            # atomic swap
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} '
              rm -rf ${REMOTE_PATH}.backup || true &&
              mv ${REMOTE_PATH} ${REMOTE_PATH}.backup || true &&
              mv ${REMOTE_PATH}.tmp ${REMOTE_PATH} &&
              chmod -R 755 ${REMOTE_PATH}
            '
            # install remote deps & restart using pm2
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} '
              cd ${REMOTE_PATH} &&
              npm install --omit=dev &&
              pm2 start start.js --name ${APP_NAME} || pm2 restart ${APP_NAME}
            '
          """
        }
      }
    }
  }

  post {
    success { echo '‚úÖ Deployment succeeded' }
    failure { echo '‚ùå Deployment failed ‚Äî check logs' }
    always  { echo 'üìú Pipeline finished' }
  }
}
